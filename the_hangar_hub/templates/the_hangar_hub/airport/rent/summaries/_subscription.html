{% load base_taglib %}

{## Parameter: rental_agreement ##}

{%with subscription=rental_agreement.stripe_subscription%}
    {%if subscription%}
        {%icon bi-heart-pulse title="Subscription Status"%}
        {{subscription.status_display}}<br />

        {%icon bi-calendar4-week title="Current Period"%}
        {{subscription.current_period_start|date:preferred_date_format}} -
        {{subscription.current_period_end|date:preferred_date_format}}<br />


        {%icon bi-credit-card title="Recurring Charge"%}
        {%format_currency subscription.amount%}<br />

        {%if subscription.canceled_at%}
            {%icon bi-calendar-x title="Canceled"%}
            {{subscription.canceled_at|date:preferred_date_format}}<br />

        {%elif subscription.ended_at%}
            {%icon bi-calendar-x title="Ended"%}
            {{subscription.ended_at|date:preferred_date_format}}<br />

        {%elif subscription.cancel_at%}
            {%icon bi-calendar-x text-danger title="Cancel at"%}
            {{subscription.ended_at|date:preferred_date_format}}<br />

        {%elif subscription.cancel_at_period_end%}
            {%icon bi-slash-circle text-danger%}
            Cancels at period end<br />
        {%endif%}

        {%if subscription.cancellation_reason%}
            {%icon bi-chat-left-text-fill title="Cancellation Reason"%}
            {{subscription.cancellation_reason}}<br />
        {%endif%}
    {%else%}
        <div class="list-group">
            <a href="{%url 'rent:subscription_checkout' airport.identifier rental_agreement.id%}" class="list-group-item">
                {%icon bi-credit-card%} Start Auto-Pay<br />
                <em style="font-size:.9em;">Must have a credit card on-hand</em>
            </a>
            <div class="list-group-item" style="cursor:pointer;" onclick="$(this).parent().find('.popup').removeClass('hidden');">
                {%icon bi-credit-card%} Configure Auto-Pay<br />
                <em style="font-size:.9em;">Tenant must complete later</em>
                <div class="popup hidden" style="max-width:400px;max-height:500px;cursor:default;">
                    <form method="post" action="{%url 'rent:subscription_email' airport.identifier rental_agreement.id%}">
                        {%csrf_token%}
                        <b>{%icon bi-credit-card%} Configure Auto-Pay</b><br />
                        <em>Email the tenant with a link to set up auto-pay.</em><br />
                        <br />
                        <div class="input-group mb-1">
                            <label class="input-group-text" for="tenant_email">To</label>
                            <input type="email" value="{{rental_agreement.tenant.email}}" id="tenant_email" class="form-control" readonly />
                        </div>
                        <div class="input-group mb-1">
                            <label class="input-group-text" for="airport_email">From</label>
                            <input type="email" value="{{airport.info_email}}" id="airport_email" name="airport_email" class="form-control" />
                        </div>


                        <br />
                        <br />
                        The link will expire at the end of the day specified:<br />

                        <div class="input-group mb-1">
                            <label class="input-group-text" for="expiration_date">Expiration Date</label>
                            <input type="date" id="expiration_date" name="expiration_date" class="form-control" />
                        </div>
                        <br />

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">{%icon bi-envelope%} Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


    {%endif%}
{%endwith%}